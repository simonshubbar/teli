{% extends "base.html" %}
{% block title %}Import — Teli{% endblock %}
{% block page %}import{% endblock %}
{% block nav_title %}Import{% endblock %}

{% block nav_left %}
    <a href="{{ url_for('index') }}" class="nav-back">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"/>
        </svg>
    </a>
{% endblock %}

{% block content %}

{% if not matches %}
    <div class="grouped-card">
        <h3 class="group-title">Batch Import</h3>
        <p class="group-subtitle">Paste a list of titles (one per line) and we'll find them on TMDB.</p>
        <form method="post" action="{{ url_for('import_search') }}">
            <textarea name="titles" rows="8"
                      placeholder="Inception
Breaking Bad
The Dark Knight
Stranger Things"
                      aria-label="Paste titles here"
                      class="ios-input">{{ raw_text or '' }}</textarea>
            <button type="submit" class="ios-btn btn-primary btn-full">Search All</button>
        </form>
    </div>
{% else %}
    <form method="post" action="{{ url_for('import_add') }}">
        <p class="group-subtitle">Review matches below. Hit <strong>Change</strong> or <strong>Search</strong> to fix any that are wrong or missing.</p>

        <div class="import-results">
            {% for m in matches %}
                <article class="import-item grouped-card">
                    <div class="import-query">
                        <strong>You typed:</strong> "{{ m.query }}"
                    </div>

                    <!-- Current match display + Change/Search button -->
                    <div class="import-match-display" id="import-display-{{ loop.index0 }}">
                        {% if m.match %}
                            <label class="import-checkbox">
                                <input type="checkbox"
                                       value="{{ loop.index0 }}"
                                       id="import-cb-{{ loop.index0 }}"
                                       {% if not m.match.on_list %}checked{% endif %}
                                       {% if m.match.on_list %}disabled{% endif %}
                                       onchange="toggleImportFields(this)">
                                <div class="import-match-info">
                                    {% if m.match.poster_url %}
                                        <img src="{{ m.match.poster_url }}" alt="{{ m.match.title }}" class="import-poster">
                                    {% else %}
                                        <div class="no-poster small">No Poster</div>
                                    {% endif %}
                                    <div>
                                        <strong>{{ m.match.title }}</strong>
                                        {% if m.match.year %}({{ m.match.year }}){% endif %}
                                        <br>
                                        <span class="media-badge {{ m.match.media_type }}">
                                            {{ 'Movie' if m.match.media_type == 'movie' else 'TV Show' }}
                                        </span>
                                        {% if m.match.on_list %}
                                            <span class="already-added">Already on list</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </label>
                            {% if not m.match.on_list %}
                            <button type="button" class="import-change-btn"
                                    onclick="toggleImportSearch({{ loop.index0 }}, this)"
                                    data-query="{{ m.query | e }}">Change</button>
                            {% endif %}
                        {% else %}
                            <label class="import-checkbox">
                                <input type="checkbox"
                                       value="{{ loop.index0 }}"
                                       id="import-cb-{{ loop.index0 }}"
                                       disabled>
                                <div class="import-no-match">No match found</div>
                            </label>
                            <button type="button" class="import-change-btn"
                                    onclick="toggleImportSearch({{ loop.index0 }}, this)"
                                    data-query="{{ m.query | e }}">Search</button>
                        {% endif %}
                    </div>

                    <!-- Inline search panel (hidden until Change/Search is clicked) -->
                    <div class="import-inline-search" id="import-search-panel-{{ loop.index0 }}">
                        <div class="import-search-bar">
                            <input type="text"
                                   class="ios-input import-search-input"
                                   id="import-search-input-{{ loop.index0 }}"
                                   placeholder="Search TMDB..."
                                   oninput="scheduleImportSearch({{ loop.index0 }})">
                            <button type="button" class="import-search-close"
                                    onclick="closeImportSearch({{ loop.index0 }})">✕</button>
                        </div>
                        <div class="import-search-results" id="import-search-results-{{ loop.index0 }}"></div>
                    </div>

                    <!-- Hidden fields submitted with the form -->
                    <div id="import-fields-{{ loop.index0 }}">
                        {% if m.match %}
                        <input type="hidden" name="tmdb_id"      value="{{ m.match.tmdb_id }}"           {% if m.match.on_list %}disabled{% endif %}>
                        <input type="hidden" name="media_type"   value="{{ m.match.media_type }}"        {% if m.match.on_list %}disabled{% endif %}>
                        <input type="hidden" name="title"        value="{{ m.match.title }}"             {% if m.match.on_list %}disabled{% endif %}>
                        <input type="hidden" name="year"         value="{{ m.match.year or '' }}"        {% if m.match.on_list %}disabled{% endif %}>
                        <input type="hidden" name="poster_path"  value="{{ m.match.poster_path or '' }}" {% if m.match.on_list %}disabled{% endif %}>
                        <input type="hidden" name="overview"     value="{{ m.match.overview or '' }}"    {% if m.match.on_list %}disabled{% endif %}>
                        {% else %}
                        <input type="hidden" name="tmdb_id"      value="" disabled>
                        <input type="hidden" name="media_type"   value="" disabled>
                        <input type="hidden" name="title"        value="" disabled>
                        <input type="hidden" name="year"         value="" disabled>
                        <input type="hidden" name="poster_path"  value="" disabled>
                        <input type="hidden" name="overview"     value="" disabled>
                        {% endif %}
                    </div>
                </article>
            {% endfor %}
        </div>

        <div class="import-actions">
            <button type="submit" class="ios-btn btn-primary">Add Selected</button>
            <a href="{{ url_for('import_page') }}" class="ios-btn btn-secondary">Start Over</a>
        </div>
    </form>
{% endif %}
{% endblock %}
